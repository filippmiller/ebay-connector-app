name: Sync Secrets to Platforms

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to sync (staging or production)'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  sync-secrets:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync to Cloudflare Pages
        run: |
          echo "Syncing secrets to Cloudflare Pages (${{ github.event.inputs.environment }})..."
          
          # Set environment variables in Cloudflare Pages
          curl -X PATCH "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/pages/projects/${{ secrets.CF_PAGES_PROJECT }}" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "deployment_configs": {
                "${{ github.event.inputs.environment }}": {
                  "env_vars": {
                    "API_PUBLIC_BASE_URL": {
                      "type": "plain_text",
                      "value": "${{ secrets.API_PUBLIC_BASE_URL }}"
                    },
                    "BASE_URL": {
                      "type": "plain_text",
                      "value": "${{ secrets.BASE_URL }}"
                    },
                    "ALLOWED_ORIGINS": {
                      "type": "plain_text",
                      "value": "${{ secrets.ALLOWED_ORIGINS }}"
                    },
                    "APP_ENV": {
                      "type": "plain_text",
                      "value": "${{ secrets.APP_ENV }}"
                    }
                  }
                }
              }
            }'
          
          echo "âœ… Cloudflare Pages secrets synced"

      - name: Sync to Railway
        run: |
          echo "Syncing secrets to Railway (${{ github.event.inputs.environment }})..."
          
          # Set environment variables in Railway using their API
          # Railway API requires setting variables one by one
          
          variables=(
            "DATABASE_URL:${{ secrets.DATABASE_URL }}"
            "JWT_SECRET:${{ secrets.JWT_SECRET }}"
            "APP_ENV:${{ secrets.APP_ENV }}"
            "API_PUBLIC_BASE_URL:${{ secrets.API_PUBLIC_BASE_URL }}"
            "BASE_URL:${{ secrets.BASE_URL }}"
            "ALLOWED_ORIGINS:${{ secrets.ALLOWED_ORIGINS }}"
            "EBAY_ENV:${{ secrets.EBAY_ENV }}"
            "EBAY_CLIENT_ID:${{ secrets.EBAY_CLIENT_ID }}"
            "EBAY_CLIENT_SECRET:${{ secrets.EBAY_CLIENT_SECRET }}"
            "EBAY_RUNAME:${{ secrets.EBAY_RUNAME }}"
            "OAUTH_STATE_TTL_SEC:${{ secrets.OAUTH_STATE_TTL_SEC }}"
            "OAUTH_REDIRECT_PATH:${{ secrets.OAUTH_REDIRECT_PATH }}"
            "WEBHOOK_VERIFY:${{ secrets.WEBHOOK_VERIFY }}"
            "CRON_SECRET:${{ secrets.CRON_SECRET }}"
            "CRON_EBAY_REFRESH:${{ secrets.CRON_EBAY_REFRESH }}"
          )
          
          for var in "${variables[@]}"; do
            key="${var%%:*}"
            value="${var#*:}"
            
            echo "Setting $key..."
            curl -X POST "https://backboard.railway.app/graphql/v2" \
              -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data "{
                \"query\": \"mutation variableUpsert(\$input: VariableUpsertInput!) { variableUpsert(input: \$input) }\",
                \"variables\": {
                  \"input\": {
                    \"projectId\": \"${{ secrets.RAILWAY_PROJECT_ID }}\",
                    \"environmentId\": \"${{ secrets.RAILWAY_ENV_ID }}\",
                    \"name\": \"$key\",
                    \"value\": \"$value\"
                  }
                }
              }"
          done
          
          echo "âœ… Railway secrets synced"

      - name: Summary
        run: |
          echo "## Secrets Sync Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Synced to:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cloudflare Pages (frontend env vars)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Railway (backend env vars)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Deploy frontend to Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
          echo "2. Deploy backend to Railway" >> $GITHUB_STEP_SUMMARY
          echo "3. Update eBay redirect URL: ${{ secrets.BASE_URL }}/connections/callback" >> $GITHUB_STEP_SUMMARY
          echo "4. Test: curl -I ${{ secrets.BASE_URL }}/api/healthz" >> $GITHUB_STEP_SUMMARY
          echo "5. Test login flow in browser" >> $GITHUB_STEP_SUMMARY

#!/usr/bin/env node
import { execSync } from 'child_process';
import { readFileSync, writeFileSync, mkdirSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const frontendDir = join(__dirname, '..');

// Get build metadata from git
const branch = execSync('git rev-parse --abbrev-ref HEAD', { encoding: 'utf-8' }).trim();
const commit = execSync('git rev-parse --short HEAD', { encoding: 'utf-8' }).trim();
const timestamp = new Date().toISOString();

// Read and increment BUILD_NUMBER from build-number.txt
const buildNumberPath = join(frontendDir, 'build-number.txt');
let buildNumber = 1;
try {
  const currentBuild = parseInt(readFileSync(buildNumberPath, 'utf-8').trim()) || 0;
  buildNumber = currentBuild + 1;
  // Write incremented number back to file
  writeFileSync(buildNumberPath, buildNumber.toString(), 'utf-8');
} catch (e) {
  // File doesn't exist, start from 1 and create it
  writeFileSync(buildNumberPath, '1', 'utf-8');
  buildNumber = 1;
}

// Target domain for production (read from environment)
const domain = process.env.DEPLOY_DOMAIN || '';

// Generate build.generated.ts
const buildGeneratedContent = `// Auto-generated by write-build-meta.mjs - DO NOT EDIT
export const BUILD_NUMBER = ${buildNumber};
export const BUILD_BRANCH = '${branch}';
export const BUILD_COMMIT = '${commit}';
export const BUILD_TIMESTAMP = '${timestamp}';
export const BUILD_DOMAIN = '${domain}';
`;

const buildGeneratedPath = join(frontendDir, 'src', 'config', 'build.generated.ts');
writeFileSync(buildGeneratedPath, buildGeneratedContent, 'utf-8');
console.log(`✓ Generated ${buildGeneratedPath}`);

// Generate version.json for dist
const versionJson = {
  number: buildNumber,
  branch: branch,
  commit: commit,
  ts: timestamp,
  domain: domain
};

// Write to public/ so Vite copies it to dist/
const publicDir = join(frontendDir, 'public');
mkdirSync(publicDir, { recursive: true });
const versionJsonPath = join(publicDir, 'version.json');
writeFileSync(versionJsonPath, JSON.stringify(versionJson, null, 2), 'utf-8');
console.log(`✓ Generated ${versionJsonPath}`);
console.log(`Build metadata: #${buildNumber} ${branch}@${commit} ${timestamp}`);
